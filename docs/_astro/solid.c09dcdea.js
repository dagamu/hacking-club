const p={context:void 0,registry:void 0};function A(t){p.context=t}function O(){return{...p.context,id:`${p.context.id}${p.context.count++}-`,count:0}}const R=(t,e)=>t===e,m={equals:R};let C=k;const a=1,b=2,U={owned:null,cleanups:null,context:null,owner:null};var o=null;let d=null,l=null,i=null,c=null,x=0;function P(t,e){const s=l,n=o,r=t.length===0,u=r?U:{owned:null,cleanups:null,context:null,owner:e===void 0?n:e},f=r?t:()=>t(()=>g(()=>E(u)));o=u,l=null;try{return h(f,!0)}finally{l=s,o=n}}function Q(t,e){e=e?Object.assign({},m,e):m;const s={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},n=r=>(typeof r=="function"&&(r=r(s.value)),N(s,r));return[$.bind(s),n]}function V(t,e,s){const n=T(t,e,!1,a);S(n)}function W(t,e,s){C=I;const n=T(t,e,!1,a),r=y&&H(o,y.id);r&&(n.suspense=r),(!s||!s.render)&&(n.user=!0),c?c.push(n):S(n)}function g(t){if(l===null)return t();const e=l;l=null;try{return t()}finally{l=e}}let y;function $(){if(this.sources&&this.state)if(this.state===a)S(this);else{const t=i;i=null,h(()=>v(this),!1),i=t}if(l){const t=this.observers?this.observers.length:0;l.sources?(l.sources.push(this),l.sourceSlots.push(t)):(l.sources=[this],l.sourceSlots=[t]),this.observers?(this.observers.push(l),this.observerSlots.push(l.sources.length-1)):(this.observers=[l],this.observerSlots=[l.sources.length-1])}return this.value}function N(t,e,s){let n=t.value;return(!t.comparator||!t.comparator(n,e))&&(t.value=e,t.observers&&t.observers.length&&h(()=>{for(let r=0;r<t.observers.length;r+=1){const u=t.observers[r],f=d&&d.running;f&&d.disposed.has(u),(f?!u.tState:!u.state)&&(u.pure?i.push(u):c.push(u),u.observers&&D(u)),f||(u.state=a)}if(i.length>1e6)throw i=[],new Error},!1)),e}function S(t){if(!t.fn)return;E(t);const e=o,s=l,n=x;l=o=t,j(t,t.value,n),l=s,o=e}function j(t,e,s){let n;try{n=t.fn(e)}catch(r){return t.pure&&(t.state=a,t.owned&&t.owned.forEach(E),t.owned=null),t.updatedAt=s+1,F(r)}(!t.updatedAt||t.updatedAt<=s)&&(t.updatedAt!=null&&"observers"in t?N(t,n):t.value=n,t.updatedAt=s)}function T(t,e,s,n=a,r){const u={fn:t,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:o,context:null,pure:s};return o===null||o!==U&&(o.owned?o.owned.push(u):o.owned=[u]),u}function w(t){if(t.state===0)return;if(t.state===b)return v(t);if(t.suspense&&g(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<x);)t.state&&e.push(t);for(let s=e.length-1;s>=0;s--)if(t=e[s],t.state===a)S(t);else if(t.state===b){const n=i;i=null,h(()=>v(t,e[0]),!1),i=n}}function h(t,e){if(i)return t();let s=!1;e||(i=[]),c?s=!0:c=[],x++;try{const n=t();return G(s),n}catch(n){s||(c=null),i=null,F(n)}}function G(t){if(i&&(k(i),i=null),t)return;const e=c;c=null,e.length&&h(()=>C(e),!1)}function k(t){for(let e=0;e<t.length;e++)w(t[e])}function I(t){let e,s=0;for(e=0;e<t.length;e++){const n=t[e];n.user?t[s++]=n:w(n)}for(p.context&&A(),e=0;e<s;e++)w(t[e])}function v(t,e){t.state=0;for(let s=0;s<t.sources.length;s+=1){const n=t.sources[s];if(n.sources){const r=n.state;r===a?n!==e&&(!n.updatedAt||n.updatedAt<x)&&w(n):r===b&&v(n,e)}}}function D(t){for(let e=0;e<t.observers.length;e+=1){const s=t.observers[e];s.state||(s.state=b,s.pure?i.push(s):c.push(s),s.observers&&D(s))}}function E(t){let e;if(t.sources)for(;t.sources.length;){const s=t.sources.pop(),n=t.sourceSlots.pop(),r=s.observers;if(r&&r.length){const u=r.pop(),f=s.observerSlots.pop();n<r.length&&(u.sourceSlots[f]=n,r[n]=u,s.observerSlots[n]=f)}}if(t.owned){for(e=t.owned.length-1;e>=0;e--)E(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0,t.context=null}function F(t){throw t}function H(t,e){return t?t.context&&t.context[e]!==void 0?t.context[e]:H(t.owner,e):void 0}let L=!1;function z(){L=!0}function B(t,e){if(L&&p.context){const s=p.context;A(O());const n=g(()=>t(e||{}));return A(s),n}return g(()=>t(e||{}))}export{V as a,B as b,P as c,Q as d,z as e,W as f,p as s};
